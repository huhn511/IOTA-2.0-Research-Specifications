<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.3">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Material+Icons"><title data-react-helmet="true">5.3 Mana | IOTA-2.0-Research-Specifications</title><meta data-react-helmet="true" property="og:url" content="https://github.com/iotaledger/IOTA-2.0-Research-Specifications/IOTA-2.0-Research-Specifications/docs/5.3 Mana"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="5.3 Mana | IOTA-2.0-Research-Specifications"><meta data-react-helmet="true" name="description" content="5.3.1 Introduction"><meta data-react-helmet="true" property="og:description" content="5.3.1 Introduction"><link data-react-helmet="true" rel="shortcut icon" href="/IOTA-2.0-Research-Specifications/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://github.com/iotaledger/IOTA-2.0-Research-Specifications/IOTA-2.0-Research-Specifications/docs/5.3 Mana"><link data-react-helmet="true" rel="alternate" href="https://github.com/iotaledger/IOTA-2.0-Research-Specifications/IOTA-2.0-Research-Specifications/docs/5.3 Mana" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://github.com/iotaledger/IOTA-2.0-Research-Specifications/IOTA-2.0-Research-Specifications/docs/5.3 Mana" hreflang="x-default"><link rel="stylesheet" href="/IOTA-2.0-Research-Specifications/assets/css/styles.e42a1e77.css">
<link rel="preload" href="/IOTA-2.0-Research-Specifications/assets/js/runtime~main.6d56e3c9.js" as="script">
<link rel="preload" href="/IOTA-2.0-Research-Specifications/assets/js/main.4593505c.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/IOTA-2.0-Research-Specifications/"><img src="/IOTA-2.0-Research-Specifications/img/logo.svg" alt="IOTA-2.0-Research-Specifications" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/IOTA-2.0-Research-Specifications/img/logo.svg" alt="IOTA-2.0-Research-Specifications" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"></a><a class="navbar__item navbar__link navbar__link--active" href="/IOTA-2.0-Research-Specifications/docs/preface">Specification</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/iotaledger/IOTA-2.0-Research-Specifications" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--checked react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" checked="" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/IOTA-2.0-Research-Specifications/"><img src="/IOTA-2.0-Research-Specifications/img/logo.svg" alt="IOTA-2.0-Research-Specifications" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/IOTA-2.0-Research-Specifications/img/logo.svg" alt="IOTA-2.0-Research-Specifications" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link navbar__link--active" href="/IOTA-2.0-Research-Specifications/docs/preface">Specification</a></li><li class="menu__list-item"><a href="https://github.com/iotaledger/IOTA-2.0-Research-Specifications" target="_blank" rel="noopener noreferrer" class="menu__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu menu--responsive thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA" aria-label="Sidebar navigation"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/IOTA-2.0-Research-Specifications/docs/preface">Preface</a></li><li class="menu__list-item"><a class="menu__link" href="/IOTA-2.0-Research-Specifications/docs/1.1 Introduction">1.1 Introduction</a></li><li class="menu__list-item"><a class="menu__link" href="/IOTA-2.0-Research-Specifications/docs/2.2 Message Layout">2.2 Message Layout</a></li><li class="menu__list-item"><a class="menu__link" href="/IOTA-2.0-Research-Specifications/docs/2.3 Standard Payloads Layout">2.3 Standard Payloads Layout</a></li><li class="menu__list-item"><a class="menu__link" href="/IOTA-2.0-Research-Specifications/docs/2.4 Data Flow">2.4 Data flow</a></li><li class="menu__list-item"><a class="menu__link" href="/IOTA-2.0-Research-Specifications/docs/3.3 Peer Discovery">3.3 Peer Discovery</a></li><li class="menu__list-item"><a class="menu__link" href="/IOTA-2.0-Research-Specifications/docs/3.4 Neighbor Selection">3.4 Neighbor Selection</a></li><li class="menu__list-item"><a class="menu__link" href="/IOTA-2.0-Research-Specifications/docs/4.1 The Tangle">4.1 The Tangle</a></li><li class="menu__list-item"><a class="menu__link" href="/IOTA-2.0-Research-Specifications/docs/4.2 Timestamps">4.2 Timestamps</a></li><li class="menu__list-item"><a class="menu__link" href="/IOTA-2.0-Research-Specifications/docs/4.3 Tip Selection Algorithm">4.3 Tip Selection Algorithm</a></li><li class="menu__list-item"><a class="menu__link" href="/IOTA-2.0-Research-Specifications/docs/4.4 Solidification">4.4 Solidification</a></li><li class="menu__list-item"><a class="menu__link" href="/IOTA-2.0-Research-Specifications/docs/4.5 Rate Control">4.5 Rate Control through Adaptive Proof of Work</a></li><li class="menu__list-item"><a class="menu__link" href="/IOTA-2.0-Research-Specifications/docs/4.6 Congestion Control">4.6 Congestion control</a></li><li class="menu__list-item"><a class="menu__link" href="/IOTA-2.0-Research-Specifications/docs/4.7 Markers">4.7 Markers</a></li><li class="menu__list-item"><a class="menu__link" href="/IOTA-2.0-Research-Specifications/docs/5.1 UTXO">5.1 UTXO</a></li><li class="menu__list-item"><a class="menu__link" href="/IOTA-2.0-Research-Specifications/docs/5.2 Ledger State">5.2 Ledger State</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" href="/IOTA-2.0-Research-Specifications/docs/5.3 Mana">5.3 Mana</a></li><li class="menu__list-item"><a class="menu__link" href="/IOTA-2.0-Research-Specifications/docs/6.1 Objects of Consensus">6.1 Objects of Consensus</a></li><li class="menu__list-item"><a class="menu__link" href="/IOTA-2.0-Research-Specifications/docs/6.2 Opinion Setting">6.2 Opinion Setting</a></li><li class="menu__list-item"><a class="menu__link" href="/IOTA-2.0-Research-Specifications/docs/6.3 Fast Probabilistic Consensus">6.3 Fast Probabilistic Consensus</a></li><li class="menu__list-item"><a class="menu__link" href="/IOTA-2.0-Research-Specifications/docs/6.4 Finalization">6.4 Approval Weight and Finality</a></li><li class="menu__list-item"><a class="menu__link" href="/IOTA-2.0-Research-Specifications/docs/6.5 dRNG">6.5 Distributed Random Number Generator</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="markdown"><header><h1 class="h1Heading_27L5">5.3 Mana</h1></header><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="531-introduction"></a>5.3.1 Introduction<a class="hash-link" href="#531-introduction" title="Direct link to heading">#</a></h2><p>This section introduces  <em>access Mana</em> and <em>consensus Mana</em> and determines which modules use each of these two types of Mana.</p><p>Any permissionless system needs a Sybil protection mechanism. In Coordicide, this is done by forcing every node to create a node identity (see also [Section 3.3 - Peer Discovery](./2.1 Peer Discovery.md)). Since the creation of an arbitrarily large number of identities is not an expensive operation, two <em>Difficult-to-obtain</em> resources are linked to each node identity; we call them <em>access Mana</em>(<strong>aMana</strong>) and <em>consensus Mana</em> (<strong>cMana</strong>). Both kinds of Mana can be described as essential resources to multiple parts of the network. They are related to the IOTA token, but are not tokens by themselves  and do not interfere with the token balance in any direct way. When a transaction is processed, a certain amount of aMana and cManaâ€”dependent on the amount of IOTAs moved by the transactionâ€”will be pledged to nodes specified in the transaction (their node IDs must be specified as defined in [Section 2.2 - Standard Payloads Layout](./2.2 Standard Payloads Layout.md)). The access and consensus Mana pledged to each node ID must be stored as an extension of the ledger state. The only way a node can obtain aMana or cMana is to convince some ken holders to pledge to it. Both kinds of Mana provides adequate Sybil protection because they are difficult and costly to be acquired in arbitrarily large amounts.  </p><p>Access and consensus Mana are used as Sybil protection in different modules, which have different natures and requirements. For this reason, it is natural to use different formulas to calculate the appropriate Mana to each module. Consensus Mana should be seen as the Mana that is responsible for the security of the system, on the other hand, access Mana is used to distribute access to the network during congestion periods.</p><p>We give a short overview on how each module uses its associated kind of Mana:</p><ul><li>[Section 3.4 - Neighbor Selection](./3.4 Neighbor Selection.md):  Nodes only establish a connection with nodes of similar consensus Mana.</li><li>[Section 4.6 - Congestion Control](./4.6 Congestion Control.md): The throughput (in bytes per second) of each node is dependent on the access Mana held.</li><li>[Section 6.3 -  Fast Probabilistic Consensus](./6.3 Fast Probabilistic Consensus.md): The selection probability for a node during a voting query is proportional to the consensus Mana held.</li><li>[Section 6.4 - Finalization](./6.4 Finalization.md): Finalization occurs when (among other criteria) a message is approved by nodes holding a certain fraction of the consensus Mana in the network.</li><li>[Section 6.6 - Distributed Random Number Generator](./6.6 dRNG.md): The dRNG committee members must be composed by high consensus Mana nodes.</li></ul><p>The Mana specification depends on the following specification:</p><ul><li>[4.2 - Timestamps](./4.2 Timestamps.md)</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="532-detailed-design---general"></a>5.3.2. Detailed Design - General<a class="hash-link" href="#532-detailed-design---general" title="Direct link to heading">#</a></h2><p>Each transaction must have an <code>accessManaNodeID</code> and a <code>consensusManaNodeID</code> field to determine which node to pledge these two types of Mana. Both of these fields consist of a node ID of the node that will receive each kind of Mana. Access Mana and consensus Mana do not have to be pledged to the same node.</p><p>Both kinds of Mana are <em>exponential moving averages</em> (EMA) of the <em>base Manas</em> (specifically, cMana is the EMA of base cMana, and aMana is the EMA of base aMana). An EMA is a type of moving average that places a greater weight and significance on the most recent data points. More precisely, the weighting for older data decreases exponentially in time, however, never reaching zero.   </p><p>Even though the definition of an EMA should be unique (no matter to which function that you apply it), the general algorithm for the calculation of the EMAsâ€”with the flexibility needed in our caseâ€”is not easily implementable. Thus, two different algorithms already customized for each type of Mana are provided in the present document.</p><p>We define the following parameters:</p><ul><li>$\gamma$- decay factor for base aMana.</li><li>$\alpha$- moving average factor for the cMana. </li><li>$\beta$- moving average factor for the aMana. </li></ul><p>Additionally, we define four vectors that assign a real value to each node Id: the <em>aMana vector</em>, <em>base aMana vector</em>, <em>cMana vector</em> and base <em>cMana vector</em>. The base aMana vector and the base cMana vector are auxiliary vectors (meaning that they are needed to compute the aMana vector and the cMana vector, even though their values are not directly used in any of the modules). Due to the time dependance of the EMA (and also the base aMana function), the four vectors have a <em>reference time</em> to which they are associated.</p><p>The Mana vectors are updated in different occasions. Access Mana pledging happens when a transaction is booked on the ledger state. At the same time, entries of the nodes whose aMana is not being modified during the pledging are updated only with respect to the (possibly) newer time reference. In general, updates only due to time (without aMana pledging) happen whenever a node&#x27;s aMana is being accessed by an external module (as the congestion control, for instance). </p><p>On the other hand, cMana is updated only relatively to the end of each epoch (see [Section 4.2 - Timestamps](./4.2 Timestamps.md)). The reason behind this is that epochs are objective, i.e. all nodes agree on which epoch a certain message (or transaction) belongs to. Thus, since nodes agree (with high probability) about transactions with timestamps older than the end of the epoch plus <code>TIMESTAMP_CUTOFF</code> (see [Section 4.2 - Timestamps](./4.2 Timestamps.md)), they will consequently agreeâ€”again, with high probabilityâ€“about the cMana vector relative to these transactions. </p><p>Therefore, one can assume that the nodes in sync will (with high probability) agree on values of cMana relative to the set of transactions that have timestamp older than a fixed epoch in the past. On the other hand, aMana will capture recent fluctuations, but nodes are expected to have slightly different perceptions of this quantity.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="533-detailed-design---consensus-mana"></a>5.3.3 Detailed Design - Consensus Mana<a class="hash-link" href="#533-detailed-design---consensus-mana" title="Direct link to heading">#</a></h2><p>The base cMana of a node <code>nodeID</code> at time <code>time</code> is defined as the sum over all unspent outputs at time <code>time</code> of transactions  with  <code>consensusManaNodeID = nodeID</code>. This means that, when an output is consumed, its cMana pledge is revoked and pledged to a (possibly) different node. See the example below: </p><p><strong>Example 1:</strong></p><p>Suppose transaction $z$ was booked and we want to update the base cMana vector accordingly. Additionally, suppose transaction $z$, $x$ and $y$ pledges cMana to nodes $N_z$,  $N_x$ and $N_y$, respectively.</p><img src="https://github.com/iotaledger/Coordicide-Specifications/blob/section/mana/images/cmana.png"><p><strong>Image 5.3.1:</strong> Illustration of outputs being consumed.</p><p>The update of the base cMana proceeds as follows: </p><ol><li>Add 300 to the base cMana state of the node $N_z$.</li><li>Subtract 100 from the base cMana state of the node $N_x$.</li><li>Subtract 200 from the base cMana state of the node $N_y$.</li></ol><p>If a transaction $T_i$ with timestamp $t_i$ pledges $M_i$ cMana to a node $Z$, then the cMana evolution over time relative to this transaction will be given by:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$$</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">cMana</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">_Z^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">T_i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">t</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">begin</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">cases</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token number">0</span><span class="token plain">, </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> t</span><span class="token operator">&lt;</span><span class="token plain"> t_i </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        M_i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">left</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1</span><span class="token plain">-e^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">alpha </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">t-t_i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">right</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">, </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> t</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">geq t_i  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">end</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">cases</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$$</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The total cMana of a node $Z$ will be, then, given by the sum of $\text{cMana}_Z^{T_i}(t)$ among all the transactions $T_i$ that pledge cMana to node $Z$. Nevertheless, computing the mana using this equation may be excessively demanding in the case where a node has multiples pledges at different times. For that reason, the cMana shall be computed recursively, updating it based on its last value. This update is customized for three different situations (here, $t_0$ is the reference time of the previous cMana value):</p><ol><li>pledging of the cMana relative to a transaction with timestamp smaller than $t_0$.  </li><li>pledging of the cMana relative to a transaction with timestamp larger than $t_0$.  </li><li>updating the cMana to a time $t_1&gt;t_0$ without any new cMana pledging.</li></ol><p>In the first case, the reference time of the cMana must not be changed, whereas in the second case, the reference time of the cMana must be changed to the timestamp of the transaction. This means that a node must never update the cMana to a point in the past (relatively to the last cMana calculated). The exact update procedure for each of the cases defined above are defined next.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="5331-consensus-mana-update-procedure"></a>5.3.3.1 Consensus Mana update procedure<a class="hash-link" href="#5331-consensus-mana-update-procedure" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="pledging-the-cmana-relative-to-a-transaction-with-timestamp-smaller-than-the-last-reference-time"></a>Pledging the cMana relative to a transaction with timestamp smaller than the last reference time<a class="hash-link" href="#pledging-the-cmana-relative-to-a-transaction-with-timestamp-smaller-than-the-last-reference-time" title="Direct link to heading">#</a></h4><p>Suppose that the last reference time is $t$ and the transaction timestamp is $t-s$. The update must be done in two steps, always in the order specified below:</p><ul><li><p><em>a</em>) <strong>Base cMana update</strong>. Just before updating the base cMana vector we must store it, since the last base cMana state (that we call $\text{Old_Base_cMana}$) and the time relative to the last update are used later for the cMana calculations. This temporary vector can be deleted right after the cMana vector is updated.</p><p>  The update of the base cMana state goes as follows: if a new transaction with $n$ inputs of values $x_1, x_2, \ldots, x_n$ pledges cMana to a node $N$, then</p><ol><li>we add $\sum_{j=1}^{n}x_j$ to the base cMana of the node $N$.</li><li>Each input $I_j$ corresponds to some UTXO (and, consequently, to some transaction) stored in the ledger state. Then, we locate the node Id (let us say, $\text{Node}_j$) to whom the cMana relative to this output was pledged to in the past. Then, we subtract $x_j$ from the base cMana state of the node $\text{Node}_j$, for each $I_j$, $j=1,\dots,n$.</li></ol></li><li><p><em>b</em>) <strong>Pledging and revoking cMana</strong>. If the base cMana balance of node $i$ (before we added this transaction) was $\text{Old_Base_cMana}(\text{Node}_i)$ and the new base cMana balance (after the addition of this transaction) is $\text{Base_cMana}(\text{Node}_i)$, then we update the cMana vector adding to all nodes&#x27; entry the term:</p></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$$</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1</span><span class="token plain">-e^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">alpha s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Base</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">_cMana</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">_i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Old</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">_Base</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">_cMana</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">_i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$$</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    The term above can be negativeâ€”since some nodes have their base cMana revokedâ€”but the resulting cMana must not be. Notice that </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">most</span><span class="token plain"> nodes </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">specifically, </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> all nodes that did not have their base cMana value changed</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> the value above is zero.</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="pledging-the-cmana-relative-to-a-transaction-with-timestamp-larger-than-the-last-reference-time"></a>Pledging the cMana relative to a transaction with timestamp larger than the last reference time<a class="hash-link" href="#pledging-the-cmana-relative-to-a-transaction-with-timestamp-larger-than-the-last-reference-time" title="Direct link to heading">#</a></h4><p>Suppose that the last reference time is $t-s$ and the transaction timestamp is $t$. The update must be done in two steps, always in the order specified below:</p><ul><li><p><em>a</em>) <strong>Base cMana update</strong>. Just before updating the base cMana vector we must store it, since the last base cMana state (that we call $\text{Old_Base_cMana}$) and the time relative to the last update are used later for the cMana calculations. This temporary vector can be deleted right after the cMana vector is updated.</p><p>  The update of the base cMana state goes as follows: if a new transaction with $n$ inputs of respective values $x_1, x_2, \ldots, x_n$ pledges cMana to a node $N$, then</p><ol><li>we add $\sum_{j=1}^{n}x_j$ to the base cMana of the node $N$.</li><li>Each input $I_j$ corresponds to some UTXO (and, consequently, to some transaction) stored in the ledger state. Then, we locate the node Id (let us say, $\text{Node}_j$) to whom the cMana relative to this output was pledged to in the past. Then, we subtract $x_j$ from the base cMana state of the node $\text{Node}_j$, for each $I_j$, $j=1,\dots,n$.</li></ol></li><li><p><em>b</em>) <strong>Updating the cMana with respect to time</strong>. Suppose that the outdated cMana is $\text{Old_cMana}$. We update all cMana entries as follows:</p></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$$</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">cMana</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">_i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">=</span><span class="token plain">e^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">alpha s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Old</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">_cMana</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">_i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">+</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1</span><span class="token plain">-e^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">alpha s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Old</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">_Base</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">_cMana</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">_i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$$</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    where $</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">alpha$ is the moving average parameter </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> the cMana. </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="updating-the-cmana-to-a-time-larger-than-the-last-reference-time-without-any-new-cmana-pledging"></a>Updating the cMana to a time larger than the last reference time without any new cMana pledging<a class="hash-link" href="#updating-the-cmana-to-a-time-larger-than-the-last-reference-time-without-any-new-cmana-pledging" title="Direct link to heading">#</a></h4><p>Suppose that the last reference time is $t-s$, the new one is $t$ and the last cMana vector is $\text{Old_cMana}$. We update all cMana entries as follows:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$$</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">cMana</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">_i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">=</span><span class="token plain">e^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">alpha s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Old</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">_cMana</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">_i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">+</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1</span><span class="token plain">-e^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">alpha s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Old</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">_Base</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">_cMana</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">_i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$$</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    where $</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">alpha$ is the moving average parameter </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> the cMana. </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="5332-active-consensus-mana-and-epochs"></a>5.3.3.2 Active Consensus Mana and Epochs<a class="hash-link" href="#5332-active-consensus-mana-and-epochs" title="Direct link to heading">#</a></h3><p>The consensus Mana of a node is only calculated and stored relatively to the end of each epoch (see [Section 4.2 - Timestamps](./4.2 Timestamps.md)). Only the values of the last <code>MAX_STORED_EPOCHS</code> epochs are stored. Thus, if $t_E$ is the time of the end of epoch $E$, to update the cMana vector from epoch $E-1$ to $E$, a node must perform the following algorithm:</p><ol><li><p>Update the cMana with respect to time, as described in section 4.3.3.1.3, from time $t<em>{E-1}$ to $t</em>{E}$</p></li><li><p>For each transaction with timestamp in the interval $[t<em>{E-1},t</em>{E})$, perform (as described in section 4.3.3.1.1) the base cMana update and the pledge and revoking of cMana, while the reference time $t_{E}$ remains constant.</p></li></ol><p>Additionally, we define the <em>active consensus Mana</em> of a node A in epoch E (i.e., relatively to time $t<em>{E}$) as (here, $\text{cMana}$ is also relative to time $t</em>{E}$):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$$</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Active</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">_cMana</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Node A</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">=</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">begin</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">cases</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">cMana</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Node A</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">, </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> there is at least one message from node </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">`</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">node</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">`</span><span class="token plain"> with timestamp </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">t_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">E-1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">,t_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">E</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token number">0</span><span class="token plain">, </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> otherwise</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">end</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">cases</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$$</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Therefore, even if node <code>node</code> has consensus Mana greater than zero at a certain epoch $E$, it can be considered dormant in case it did not issue any message during the same epoch. All nodes that have active consensus Mana in epoch $E$ will form what we call the active consensus Mana set of that epoch, or <code>ACMS(E)</code>.</p><p>Both calculations defined above (cMana and active cMana on an epoch $E$) can only be carried out when epoch $E$ is finalizedâ€”that is, at least <code>TIMESTAMP_CUTOFF</code> (see [Section 4.2 - Timestamps](./4.2 Timestamps.md)) units of time after $t_E$â€”to make sure that no more messages belonging to the epoch will appear in the network.</p><p>The following data structures and functions must be defined:</p><ul><li><p><code>UpdatecMana(epoch)</code>: updates the base cMana and cMana vectors from the end of <code>epoch-1</code> to <code>epoch</code>, pledging and revoking the base cMana and cMana relative to all the relevant transactions. </p></li><li><p><code>GetActiveConsensusMana(time)</code>: returns a mapping between all known nodes and their active cMana, calculated at the end of the epoch that contains <code>time</code>.</p></li><li><p><code>ManaRank(lowerMana, upperMana, epoch)</code>: returns the node ID of the nodes with active cMana in the interval <code>[lowerMana, upperMana]</code>, relative to <code>epoch</code>. Notice that <code>epoch</code> must be, at least, the current epoch minus <code>MAX_STORED_EPOCHS</code> and, at most, the last epoch.</p></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="534-detailed-design---access-mana"></a>5.3.4 Detailed Design - Access Mana<a class="hash-link" href="#534-detailed-design---access-mana" title="Direct link to heading">#</a></h2><p>When an output is consumed and funds are consequently transferred, a certain amount of base aManaâ€”dependent on the amount of funds and the age of the outputâ€”will be pledged to a node. This pledge is never revoked, as opposed to base cMana. Nevertheless, the base aMana of all nodes will <em>decay</em> over time, which means that all the calculations for aMana will be slightly different than for cMana. The base aMana at time $t$, relative to an output $T_i$ (of amount $M_i$) consumed by a transaction with timestamp $t-s$ and generated by a transaction with timestamp $t-s-\delta$ is, for $s,\delta&gt;0$</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$$</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Base</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">_aMana</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">T_i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">t</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">=</span><span class="token plain"> M </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1</span><span class="token plain">-e^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">gamma </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">delta</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> e^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">gamma s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">, </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> t</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">geq t-s</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$$</span><span class="token plain"> </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>If this same output pledges aMana to a node $Z$, then the aMana evolution over time (again, for $s,\delta&gt;0$) relative to it will be given by:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$$</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">aMana</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">_Z^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">T_i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">t</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">begin</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">cases</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        M_i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1</span><span class="token plain">-e^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">gamma</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">delta</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">dfrac</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">beta e^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">beta s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">beta-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">gamma</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">left</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">e^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">beta-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">gamma</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">-1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">right</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">, </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">beta</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">neq </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">gamma</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        M_i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1</span><span class="token plain">-e^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">gamma</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">delta</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">gamma s e^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">gamma s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">, </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">beta</span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">gamma</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">end</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">cases</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$$</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The base aMana of a node <code>nodeID</code> at time <code>time</code> is defined as the sum of the individual base aMana generated by all already consumed outputs $T_i$ of transactions  with  <code>accessManaNodeID = nodeID</code> and timestamp smaller or equal than <code>time</code>. Nevertheless, as in the cMana case, computing the aMana using this equation can be excessively demanding. For that reason, the aMana shall computed recursively, updating it based on its last value. This update is customized for three different situations (here, $t_0$ is the reference time of the last aMana value):</p><ol><li>pledging of the aMana relative to a transaction with timestamp smaller than $t_0$;</li><li>pledging of the aMana relative to a transaction with timestamp larger than $t_0$;</li><li>updating the aMana to a time $t_1&gt;t_0$ without any new aMana pledging.</li></ol><p>In the first case, the reference time of the aMana must not be changed, whereas in the second case, the reference time of the cMana must be changed to the timestamp of the transaction. This means that a node must never update the aMana to a point in the past (relatively to the last aMana calculated). The exact update procedure for each of the cases defined above are defined next.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="5341-access-mana-update-procedure"></a>5.3.4.1 Access Mana update procedure<a class="hash-link" href="#5341-access-mana-update-procedure" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="pledging-the-amana-relative-to-a-transaction-with-timestamp-smaller-than-the-last-reference-time"></a>Pledging the aMana relative to a transaction with timestamp smaller than the last reference time<a class="hash-link" href="#pledging-the-amana-relative-to-a-transaction-with-timestamp-smaller-than-the-last-reference-time" title="Direct link to heading">#</a></h4><p>Suppose that the last reference time is $t$ and the transaction timestamp is $t-s$. The update must be done in two steps, always in the order specified below:</p><ul><li><strong>Base aMana pledging</strong>. Suppose that the new transaction consists of $m$ inputs $I_1, I_2, \ldots, I_m$ of value $x_1, x_2, \ldots, x_m$â€”respectivelyâ€”and pledges aMana to a node $N$. We update the base aMana of node $N$ by adding to its base aMana the value</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$$</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">d</span><span class="token operator">=</span><span class="token plain">e^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">gamma s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">sum_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">j</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">m</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">x_j</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1</span><span class="token plain">-e^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">gamma </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">delta_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">j</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$$</span><span class="token plain"> </span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    where $</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">delta_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">j</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token plain">$ is the difference between </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$t</span><span class="token plain">$ and the timestamps of the transaction that generated </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$I_j</span><span class="token plain">$ and $</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">gamma$ is the decay factor. This value </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$d</span><span class="token plain">$ has to be temporarily stored, since it will be used </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> the aMana update.</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li><strong>Pledging aMana</strong>. We update the aMana vector adding to node $N$&#x27;s entry the term:</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$$</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">begin</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">cases</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">  </span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">frac</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">e^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">gamma s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">-e^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">beta s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">beta-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">gamma</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">e^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">gamma s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">beta d,</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">beta</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">neq</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">gamma</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    s </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">beta d,</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">beta</span><span class="token operator">=</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">gamma,</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">end</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">cases</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$$</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    where the term </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$d</span><span class="token plain">$ is the same it was added when updating the base aMana vector. </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="pledging-the-amana-relative-to-a-transaction-with-timestamp-larger-than-the-last-reference-time"></a>Pledging the aMana relative to a transaction with timestamp larger than the last reference time<a class="hash-link" href="#pledging-the-amana-relative-to-a-transaction-with-timestamp-larger-than-the-last-reference-time" title="Direct link to heading">#</a></h4><p>Suppose that the last reference time is $t-s$ and the transaction timestamp is $t$. The update must be done in three steps, always in the order specified below:</p><ul><li><strong>Base aMana update with respect to time</strong>. Suppose that the last base aMana is $\text{Old_Base_aMana}$. We update all base aMana entries as follows:</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$$</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Base</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">_aMana</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">_i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> e^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">gamma s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Old</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">_Base</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">_aMana</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">_i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$$</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li><strong>Base aMana pledging</strong>. Suppose that the new transaction consists of $m$ inputs $I_1, I_2, \ldots, I_m$ of value $x_1, x_2, \ldots, x_m$, respectively, and pledges aMana to a node $N$. We update the base aMana of node $N$ by adding to its base aMana the value</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$$</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">d</span><span class="token operator">=</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">sum_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">j</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">m</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">x_j</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1</span><span class="token plain">-e^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">gamma </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">delta_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">j</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$$</span><span class="token plain"> </span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    where $</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">delta_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">j</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token plain">$ is the difference between </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$t</span><span class="token plain">$ and the timestamps of the transaction that generated </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$I_j</span><span class="token plain">$ and $</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">gamma$ is the decay factor. This value </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$d</span><span class="token plain">$ has to be temporarily stored, since it will be used </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> the aMana update.</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li><strong>Updating the aMana with respect to time</strong>.  We update all aMana entries as follows:</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$$</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> aMana</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">_i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">=</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">begin</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">cases</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">  </span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    e^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">beta s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Old</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">_aMana</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">_i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">+</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">frac</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">e^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">gamma s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">-e^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">beta s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">beta-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">gamma</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">e^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">gamma s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">beta</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Base</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">_aMana</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">_i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">,</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">beta</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">neq</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">gamma</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    e^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">beta s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Old</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">_aMana</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">_i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">+s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">beta</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Base</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">_aMana</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">_i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">,</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">beta</span><span class="token operator">=</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">gamma,</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">end</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">cases</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$$</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    where $</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">beta$ is the moving average parameter </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> the aMana and $</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">gamma$ is the base aMana decay factor. Notice that, here, the value of $</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Base</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">_aMana</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">Node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">_i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">$ used is the one already updated. </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="updating-the-amana-to-a-time-larger-than-the-last-reference-time-without-any-new-amana-pledging"></a>Updating the aMana to a time larger than the last reference time without any new aMana pledging.<a class="hash-link" href="#updating-the-amana-to-a-time-larger-than-the-last-reference-time-without-any-new-amana-pledging" title="Direct link to heading">#</a></h4><p>Suppose that the last reference time is $t-s$ and new one is $t$. The update must be done in two steps, always in the order specified below:</p><ul><li><strong>Base aMana update with respect to time</strong>. Suppose that the outdated base aMana is $\text{Old_Base_aMana}$. We update the base aMana entries as follows:</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$$</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Base</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">_aMana</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">_i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> e^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">gamma s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Old</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">_Base</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">_aMana</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">_i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$$</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li><strong>Updating the aMana with respect to time</strong>. We update all the aMana entries as follows:</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$$</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">aMana</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">_i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">=</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">begin</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">cases</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">  </span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    e^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">beta s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Old</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">_aMana</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">_i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">+</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">frac</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">e^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">gamma s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">-e^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">beta s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">beta-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">gamma</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">e^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">gamma s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">beta</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Base</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">_aMana</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">_i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">,</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">beta</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">neq</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">gamma</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    e^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">beta s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Old</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">_aMana</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">_i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">+s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">beta</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Base</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">_aMana</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">_i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">,</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">beta</span><span class="token operator">=</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">gamma,</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">end</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">cases</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$$</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    where $</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">beta$ is the moving average parameter </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> the aMana and $</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">gamma$ is the base aMana decay factor. Notice that, here, the value of $</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">Base</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">_aMana</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">Node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">_i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">$ used is the one already updated. </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The following data structures and functions must be defined:</p><ul><li><p><code>GetAccessMana()</code>: returns a mapping between all known nodes and their access Mana, calculated at <code>currentTime</code> (which means that the aMana is updated to <code>currentTime</code> when this function is called).</p></li><li><p><code>UpdateaMana(transaction)</code>: whenever a transaction <code>transaction</code> is added to the ledger state, it updates the aMana vector in order to add the aMana relative to <code>transaction</code> and to the (possibly) new reference time.</p></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="535-initialization"></a>5.3.5. Initialization<a class="hash-link" href="#535-initialization" title="Direct link to heading">#</a></h2><p>The Mana is an extension of the ledger state, hence its calculation depends on the ledger state perception of the node. Snapshotting is the mechanism that stores older ledger states and prunes unnecessary messages. Together with the ledger state, aMana and cMana vectors (and the reference time relative to them) are also saved, since a certain ledger state reflects a certain aMana and cMana distribution in the network. Thus, when a node joins the network, it will query other nodes to get their snapshot file, containing a <code>aMana Snapshot Vector</code>, a <code>cMana Snapshot Vector</code>, and two <code>ACMS</code> (one for each of the last two snapshotted epochs) that will be used as initialization data. </p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="536-algorithm"></a>5.3.6. Algorithm<a class="hash-link" href="#536-algorithm" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="5361-parameter-values"></a>5.3.6.1. Parameter Values<a class="hash-link" href="#5361-parameter-values" title="Direct link to heading">#</a></h3><p>The following parameters will be used by default, and all nodes must know them. We do not have explicit rules to punish nodes that clearly do not use these parameters, but we expect that they would be eventually ignored, due to other implicit mechanisms. For instance, even if the Mana vectors of a certain node are significantly different from the other nodes&#x27; view (causing a divergence from the majority&#x27;s opinion in the voting protocol), with a very high probability its opinion will not affect the final outcome of the voting. For other modules (like congestion control), a node with a significantly different perception of Mana will be blacklisted and will not harm the network. Thus, the nodes have plenty of incentives to follow the rules.</p><table><thead><tr><th>Name</th><th align="center">Type</th><th>Description</th><th>Observation</th></tr></thead><tbody><tr><td><code>DECAY</code></td><td align="center">float</td><td>decay factor for base aMana</td><td>Called $\gamma$ in the last sections. For a half life of ~6 hours we need $\gamma=0.00192541 \frac{1}{\text{min}}$.</td></tr><tr><td><code>C_MANA_EMA_COEFF</code></td><td align="center">float</td><td>moving average factor for the cMana</td><td>Called $\alpha$ in the last sections. Set as the same value as $\gamma$.</td></tr><tr><td><code>A_MANA_EMA_COEFF</code></td><td align="center">float</td><td>moving average factor for the aMana</td><td>Called $\beta$ in the last sections. Set as the same value as $\gamma$.</td></tr></tbody></table><p><strong>Table 5.3.2:</strong> List of Parameters.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="5362-local-variables-and-built-in-functions"></a>5.3.6.2. Local Variables and Built-in Functions<a class="hash-link" href="#5362-local-variables-and-built-in-functions" title="Direct link to heading">#</a></h3><table><thead><tr><th>Name</th><th align="center">Type</th><th>Description</th></tr></thead><tbody><tr><td><code>object.cManaNode</code></td><td align="center">nodeID</td><td>Id of the node to which <code>object</code>&#x27;s cMana was pledged</td></tr><tr><td><code>object.amount</code></td><td align="center">double</td><td>Amount moved by <code>object</code></td></tr><tr><td><code>object.aManaNode</code></td><td align="center">nodeID</td><td>Id of the node to which <code>object</code>&#x27;s aMana was pledged</td></tr><tr><td><code>transaction.inputs</code></td><td align="center">list of inputs IDs</td><td>List of inputs consumed by <code>transaction</code></td></tr><tr><td><code>transaction.time</code></td><td align="center">time</td><td>Timestamp of <code>transaction</code></td></tr><tr><td><code>nodes</code></td><td align="center">list of nodeIDs</td><td>List of known nodes.</td></tr><tr><td><code>epoch.finalTime</code></td><td align="center">time</td><td>Final time of <code>epoch</code></td></tr><tr><td><code>epoch.initialTime</code></td><td align="center">time</td><td>Initial time of <code>epoch</code></td></tr><tr><td><code>epoch.transactions</code></td><td align="center">list of TxIds</td><td>Set of transactions with timestamps in the interval <code>[epoch.initialTime,epoch.finalTime)</code></td></tr><tr><td><code>input.time</code></td><td align="center">time</td><td>Timestamp of the transaction that generated the output relative to <code>input</code></td></tr></tbody></table><p><strong>Table 5.3.3:</strong> Local Variables and Built-in Functions.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="5363-pseudocode---cmana-update"></a>5.3.6.3. Pseudocode - cMana Update<a class="hash-link" href="#5363-pseudocode---cmana-update" title="Direct link to heading">#</a></h2><p>In this section, for the sake of clarity, we introduce an example of code of the functions defined above. </p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="updatebasecmanatrtransaction"></a><code>UpdateBasecManaTr(transaction)</code><a class="hash-link" href="#updatebasecmanatrtransaction" title="Direct link to heading">#</a></h4><p>The function <code>UpdateBasecManaTr(transaction)</code> updates the vector <code>basecMana</code>, pledging and revoking the base cMana relative to a transaction <code>transaction</code>. </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly vbnet"><pre tabindex="0" class="prism-code language-vbnet codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">FUNCTION UpdateBasecManaTr(transaction)</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    basecMana[transaction.cManaNode] = basecMana[transaction.cManaNode]+transaction.amount </span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    FOR input in transaction.inputs</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        basecMana[input.cManaNode] = basecMana[input.cManaNode]-input.amount</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="updatecmanatimeepoch"></a><code>UpdatecManaTime(epoch)</code><a class="hash-link" href="#updatecmanatimeepoch" title="Direct link to heading">#</a></h4><p>The function <code>UpdatecManaTime(epoch)</code> updates the vector <code>cMana</code>, changing its reference time from the end of <code>epoch-1</code> to the end of <code>epoch</code>. </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly vbnet"><pre tabindex="0" class="prism-code language-vbnet codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">FUNCTION UpdatecManaTime(epoch)</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    n = epoch.finalTime-epoch.initialTime</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    FOR node in nodes</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        cMana[node] = exp(-C_MANA_EMA_COEFF*n)*cMana[node]</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        +(1-exp(-C_MANA_EMA_COEFF*n))*basecMana[node]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="updatecmanatrepochtransaction"></a><code>UpdatecManaTr(epoch,transaction)</code><a class="hash-link" href="#updatecmanatrepochtransaction" title="Direct link to heading">#</a></h4><p>The function <code>UpdatecManaTr(epoch,transaction)</code> updates the vector <code>cMana</code>, pledging and revoking the cMana relative to a transaction <code>transaction</code>. </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly vbnet"><pre tabindex="0" class="prism-code language-vbnet codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">FUNCTION UpdatecManaTr(epoch,transaction)</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    n = epoch.finalTime - transaction.time</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    FOR node in nodes</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        IF basecMana[node] != basecManaOld[node]</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            cMana[node] = cMana[node]+(1-(1-C_MANA_EMA_COEFF)**n)*(basecMana[node]-basecManaOld[node])</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="updatecmanaepoch"></a><code>UpdatecMana(epoch)</code><a class="hash-link" href="#updatecmanaepoch" title="Direct link to heading">#</a></h4><p>The function <code>UpdatecMana(epoch)</code> updates the vectors <code>cMana</code> and <code>basecMana</code>, from the end of <code>epoch-1</code> to <code>epoch</code>, pledging and revoking the base cMana and cMana relative to all the relevant transactions. </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly vbnet"><pre tabindex="0" class="prism-code language-vbnet codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">FUNCTION UpdatecMana(epoch):</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    UpdatecManaTime(epoch)</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    IF epoch.transactions != NULL:</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        FOR transaction in epoch.transactions:</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            basecManaOld = basecMana</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            UpdateBasecManaTr(transaction)</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            UpdatecManaTr(epoch,transaction)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="5364-pseudocode---amana-update"></a>5.3.6.4. Pseudocode - aMana Update<a class="hash-link" href="#5364-pseudocode---amana-update" title="Direct link to heading">#</a></h3><p>In this section, for the sake of clarity, we introduce an example of code of the functions defined above. </p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="updatebaseamanatimet"></a><code>UpdateBaseaManaTime(t)</code><a class="hash-link" href="#updatebaseamanatimet" title="Direct link to heading">#</a></h4><p>The function <code>UpdateBaseaManaTime(t)</code> updates the vector <code>baseaMana</code>, changing its reference time from <code>lastUpdateTime</code> to <code>t</code>. </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly vbnet"><pre tabindex="0" class="prism-code language-vbnet codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">FUNCTION UpdateBaseaManaTime(t)</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    n = t-lastUpdateTime</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    FOR each node i</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        baseaMana[i] = baseaMana[i]*exp(-DECAY*n)  </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="updateamanatimet"></a><code>UpdateaManaTime(t)</code><a class="hash-link" href="#updateamanatimet" title="Direct link to heading">#</a></h4><p>The function <code>UpdateaManaTime(t)</code> updates the vector <code>aMana</code>, changing its reference time from <code>lastUpdateTime</code> to <code>t</code>. </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly vbnet"><pre tabindex="0" class="prism-code language-vbnet codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">FUNCTION UpdateaManaTime(t)</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    n = t-lastUpdateTime</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    IF DECAY != A_MANA_EMA_COEFF</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        FOR each node i</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            aMana[i] = exp(-A_MANA_EMA_COEFF*n)*aMana[i]+(1-exp((DECAY-A_MANA_EMA_COEFF)*n))/(A_MANA_EMA_COEFF-DECAY))*A_MANA_EMA_COEFF*baseaMana[i]</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ELSE       </span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        FOR each node i</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            aMana[i] = exp(-A_MANA_EMA_COEFF*n)*aMana[i]+ DECAY*A_MANA_EMA_COEFF*baseaMana[i]            </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="updatebaseamanatrtransaction"></a><code>UpdateBaseaManaTr(transaction)</code><a class="hash-link" href="#updatebaseamanatrtransaction" title="Direct link to heading">#</a></h4><p>The function <code>UpdateBaseaManaTr(t,transaction)</code> updates the vector <code>baseaMana</code>, pledging the base aMana relative to a transaction <code>transaction</code>. </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly vbnet"><pre tabindex="0" class="prism-code language-vbnet codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">FUNCTION UpdateBaseaManaTr(transaction)</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    FOR input in transaction.inputs</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        baseaMana[transaction.aManaNode] = baseaMana[transaction.aManaNode]+exp(-DECAY*(MAX(transaction.time,lastUpdateTime)-transaction.time))*input.amount*(1-exp(-DECAY*(transaction.time-input.time))) </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="updateamanatrtransaction"></a><code>UpdateaManaTr(transaction)</code><a class="hash-link" href="#updateamanatrtransaction" title="Direct link to heading">#</a></h4><p>The function <code>UpdateaManaTr(transaction)</code> updates the vector <code>aMana</code>, pledging the aMana relative to a transaction <code>transaction</code>. </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly vbnet"><pre tabindex="0" class="prism-code language-vbnet codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">FUNCTION UpdateaManaTr(transaction):</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    n = lastUpdateTime-transaction.time</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    IF DECAY != A_MANA_EMA_COEFF</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        aMana[transaction.aManaNode] = aMana[transaction.aManaNode]+(exp(-DECAY*n)-exp(-A_MANA_EMA_COEFF*n))/(A_MANA_EMA_COEFF-DECAY))*A_MANA_EMA_COEFF*(baseaMana[transaction.aManaNode]-baseaManaOld[transaction.aManaNode])</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ELSE</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        aMana[aManaNode(transaction)] = aMana[transaction.aManaNode]+exp(-DECAY*n)*DECAY*A_MANA_EMA_COEFF*(baseaMana[transaction.aManaNode]-baseaManaOld[transaction.aManaNode])</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="updateamanatransaction"></a><code>UpdateaMana(transaction)</code><a class="hash-link" href="#updateamanatransaction" title="Direct link to heading">#</a></h4><p>The function <code>UpdateaMana(transaction)</code> updates the vectors <code>aMana</code> and <code>baseaMana</code>, from <code>lastUpdateTime</code> to <code>MAX(lastUpdateTime, transaction.time)</code>, pledging the base aMana and aMana relative to <code>transaction</code>. </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly vbnet"><pre tabindex="0" class="prism-code language-vbnet codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">FUNCTION UpdateaMana(transaction):</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # if the tx is not old, add it and update the vector to t   </span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    IF transaction.time &gt; lastUpdateTime:</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        UpdateBaseaManaTime(transaction.time)</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        UpdateaManaTime(transaction.time)</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        UpdateBaseaManaTr(transaction)</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        lastUpdateTime  = transaction.time        </span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # add a transaction in the past    </span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    IF transaction.time &lt; lastUpdateTime:</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        baseaManaOld = baseaMana</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        UpdateBaseaManaTr(transaction)</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        UpdateaManaTr(transaction)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div><footer class="row docusaurus-mt-lg"><div class="col"><a href="https://github.com/iotaledger/IOTA-2.0-Research-Specifications/edit/master/website/docs/5.3 Mana.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_3DPF"></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/IOTA-2.0-Research-Specifications/docs/5.2 Ledger State"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« 5.2 Ledger State</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/IOTA-2.0-Research-Specifications/docs/6.1 Objects of Consensus"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">6.1 Objects of Consensus Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#531-introduction" class="table-of-contents__link">5.3.1 Introduction</a></li><li><a href="#532-detailed-design---general" class="table-of-contents__link">5.3.2. Detailed Design - General</a></li><li><a href="#533-detailed-design---consensus-mana" class="table-of-contents__link">5.3.3 Detailed Design - Consensus Mana</a><ul><li><a href="#5331-consensus-mana-update-procedure" class="table-of-contents__link">5.3.3.1 Consensus Mana update procedure</a></li><li><a href="#5332-active-consensus-mana-and-epochs" class="table-of-contents__link">5.3.3.2 Active Consensus Mana and Epochs</a></li></ul></li><li><a href="#534-detailed-design---access-mana" class="table-of-contents__link">5.3.4 Detailed Design - Access Mana</a><ul><li><a href="#5341-access-mana-update-procedure" class="table-of-contents__link">5.3.4.1 Access Mana update procedure</a></li></ul></li><li><a href="#535-initialization" class="table-of-contents__link">5.3.5. Initialization</a></li><li><a href="#536-algorithm" class="table-of-contents__link">5.3.6. Algorithm</a><ul><li><a href="#5361-parameter-values" class="table-of-contents__link">5.3.6.1. Parameter Values</a></li><li><a href="#5362-local-variables-and-built-in-functions" class="table-of-contents__link">5.3.6.2. Local Variables and Built-in Functions</a></li></ul></li><li><a href="#5363-pseudocode---cmana-update" class="table-of-contents__link">5.3.6.3. Pseudocode - cMana Update</a><ul><li><a href="#5364-pseudocode---amana-update" class="table-of-contents__link">5.3.6.4. Pseudocode - aMana Update</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Specification</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/IOTA-2.0-Research-Specifications/docs/preface">Specification</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://discord.iota.org" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/iota" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://iota.stackexchange.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Stack Exchange<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/iotaledger/IOTA-2.0-Research-Specifications" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 IOTA Foundation. Built with Docusaurus.</div></div></div></footer></div>
<script src="/IOTA-2.0-Research-Specifications/assets/js/runtime~main.6d56e3c9.js"></script>
<script src="/IOTA-2.0-Research-Specifications/assets/js/main.4593505c.js"></script>
</body>
</html>